<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" type='text/javascript'></script>
        <style>
            table{
                border-spacing:10px;
                border-collapse: separate;
            }
            .totals td{
                font-weight:bold;
            }
        </style>
    </head>

	<body>
		<div id="ingredients_options_container">
            <select id="ingredients_list">
                <% for( var i = 0; i < foods.length; i++){%>
                    <%var food_name = foods[i].food_name; %>
                    <option value="<%= food_name%>"><%= food_name%></option> 
                <% } %>
            </select>
            <input type="button" id="add_ingredient_btn" value="Add Ingredient"></input>
		</div>
        
		<div id="recipes_options_container">
            <select id="recipes_list">
                <% for( var i = 0; i < recipes.length; i++){%>
                    <%var recipe_name = recipes[i].recipe_name; %>
                    <option value="<%= recipe_name%>"><%= recipe_name%></option> 
                <% } %>
            </select>
            <input type="button" id="add_recipe_ings_btn" value="Add From Recipe"></input>
		</div>
        <div>
            <table>
                <tbody id="ingredients_container">
                    <tr>
                        <th>Name</th>
                        <th>Unit</th>
                        <th>Amount</th>
                        <th>Calories</th>
                        <th>Fat</th>
                        <th>Carbs</th>
                        <th>Fiber</th>
                        <th>Protein</th>
                    </tr>
                </tbody>
                <tfoot id="totals_container"></tfoot>
            </table>
        </div>
        <div id="submit_container>
            <div style="width:100%">Any ingredients with amount 0 will not be included.</div>
            <input id="meal_name_input"></input>
            <input type="number" id="meal_weight_input"></input>
            <input type="submit" id="enter_meal_btn" name="action" value="Save to Fridge">
        </div>
        <input type="submit" id="one_off_btn" name="action" value="I Ate It!">

        <div id="scripts_container">
            <script>
                function total_up(id){
                    let total = 0;
                    $(`[id='${id}']`).each(function(){
                        total += parseFloat($(this).text());
                    });
                    return total;
                }

                function update_totals(){
                    let row_id = "total_row",
                        cal_id = "calories_total",
                        fat_id = "fat_total",
                        carbs_id = "carbs_total",
                        fiber_id = "fiber_total",
                        protein_id = "protein_total";
                    let maybeTotal = $("#" + row_id);

                    let total_cal = total_up("calories"), 
                        total_fat = total_up("fat"),
                        total_carbs = total_up("carb"),
                        total_fiber = total_up("fiber"),
                        total_protein = total_up("protein");

                    //Creation
                    if(maybeTotal.length === 0){      
                        $("#totals_container").append(
                            `<tr class='totals' id='${row_id}'>` +
                            "<td>Totals:</td>" +
                            "<td>N/A</td>" +
                            "<td>N/A</td>" +
                            `<td id='${cal_id}'> ${total_cal}</td>` +
                            `<td id='${fat_id}'> ${total_fat}</td>` +
                            `<td id='${carbs_id}'> ${total_carbs}</td>` +
                            `<td id='${fiber_id}'> ${total_fiber}</td>` +
                            `<td id='${protein_id}'> ${total_protein}</td>` +
                            "</tr>"
                        );
                    }
                    //Update
                    else{
                        $("#" + cal_id).text(total_cal);
                        $("#" + fat_id).text(total_fat);
                        $("#" + carbs_id).text(total_carbs);
                        $("#" + fiber_id).text(total_fiber);
                        $("#" + protein_id).text(total_protein);
                    }
                }

                $(document).ready(function(){
                    var nutrient_ids = ["calories", "fat", "carb", "fiber", "protein"]
                    //Add the ingredient to the list
                    $("#add_ingredient_btn").on('click', function(e){
                        var ingredient_name = $('select[id=ingredients_list]').val();

                        $.ajax({
                            type: 'post',
                            url: '/get_food',
                            data: {food_name: ingredient_name},
                            dataType: 'json'
                        })
                        .done(function(ingredient_info){
                            var first_ing_entry = ingredient_info[0];
                            var food_name = first_ing_entry.food_name;
                            var food_id = first_ing_entry.food_id;
                            var unit_amount_map = {};
                            for(var idx in ingredient_info){
                                let unit = ingredient_info[idx].unit;
                                unit_amount_map[unit] = parseFloat(ingredient_info[idx].amount);
                            }

                            //Check if it already was added to the page
                            //TODO add a "remove ingredient" button
                            var maybeEntry = $("#" + food_id);
                            if(maybeEntry.length === 0){
                                $("#ingredients_container").append(
                                    `<tr id='${food_id}'>` +
                                    `<td>${food_name}</td>` +
                                    "<td><select id='unit'></select></td>" +
                                    `<td><input id='amount' type='number' step='any' value='${first_ing_entry.amount}'></input></td>` +
                                    `<td id='${nutrient_ids[0]}'>${first_ing_entry.calories}</td>` +
                                    `<td id='${nutrient_ids[1]}'>${first_ing_entry.fat}</td>` +
                                    `<td id='${nutrient_ids[2]}'>${first_ing_entry.carb}</td>` +
                                    `<td id='${nutrient_ids[3]}'>${first_ing_entry.fiber}</td>` +
                                    `<td id='${nutrient_ids[4]}'>${first_ing_entry.protein}</td>` +
                                    `<input id='hid_prev_unit' type='hidden' value='${first_ing_entry.unit}'></input>` +
                                    "</tr>"
                                );

                                //No longer a maybe, in this case
                                maybeEntry = $("#" + food_id);
                                var units = maybeEntry.find("[id='unit']");

                                for(var idx in ingredient_info){
                                    units.append(`<option>${ingredient_info[idx].unit}</option>`);
                                }
                                units.on('change', function(){
                                    //The ratio between the current unit's serving size
                                    let prev_unit = maybeEntry.find("#hid_prev_unit");
                                    let curr_amount_ratio = parseFloat(maybeEntry.find("[id='amount']").val())/unit_amount_map[prev_unit.val()];
                                    let curr_amount = maybeEntry.find("#amount");
                                    curr_amount.val(unit_amount_map[units.val()] * curr_amount_ratio);
                                    prev_unit.val(this.value);

                                });
                                maybeEntry.find("#amount").on('change', function(){
                                    let curr_amount_ratio = parseFloat(maybeEntry.find("[id='amount']").val())/unit_amount_map[units.val()];
                                    nutrient_ids.forEach(function(id){
                                        let nutrient = maybeEntry.find(`#${id}`);
                                        nutrient.text(parseFloat(first_ing_entry[id])*curr_amount_ratio);
                                    })
                                    $("#ingredients_container").trigger('update');
                                });
                            }
                            else{
                                let curr_amount = maybeEntry.find("#amount");
                                let unit = maybeEntry.find("[id='unit']").val();
                                curr_amount.val(parseFloat(curr_amount.val()) + parseFloat(unit_amount_map[unit]));
                            }
                            $("#ingredients_container").trigger('update');
                        });
                    });
                    

                    $("#ingredients_container").on('update', function(){
                        update_totals();
                    });

                    $("#add_recipe_ings_btn").on('click', function(e){
                        var recipe_name = $('select[id=recipes_list]').val();

                        $.ajax({
                            type: 'post',
                            url: '/get_recipe_ingredients',
                            data: {recipe_name: recipe_name},
                            dataType: 'json'
                        })
                        .done(function(ingredients_info){
                            //TODO load the recipe ingredients onto the page
                            console.log(ingredients_info);
                        });
                    });

                    $("#enter_meal_btn").on('click', function(e){
                        let meal_name = $("#meal_name_input").val(); 
                        let meal_weight = $("#meal_weight_input").val();
                        //TODO replace this with a more elegant error message box
                        if(meal_name == "" || meal_weight == ""){
                            alert("You must provide a name and weight!");
                            return;
                        }

                        let ingredient_rows = $("#ingredients_container tr");
                        //There's always a header row we have to ignore
                        //TODO replace this with a more elegant error message box
                        if(ingredient_rows.length <= 1){
                            alert("You need to have at least one ingredient!");
                            return;
                        }
                        
                        let nutrients_list = [
                            $("#calories_total").text(),
                            $("#fat_total").text(),
                            $("#carbs_total").text(),
                            $("#fiber_total").text(),
                            $("#protein_total").text()
                        ]
                        
                        $.ajax({
                            type: 'post',
                            url: '/add_meal',
                            data: {meal_name: meal_name, meal_weight: parseFloat(meal_weight), nutrients: nutrients_list},
                            dataType: 'json'
                        })
                        .done(function(maybeError){
                            if(maybeError.err != ""){
                                let warning_container = $("#warning_container");
                                warning_container.text(maybeError.err);
                                warning_container.show();
                            }
                            else{
                                $("#warning_container").hide();
                            }
                        });

                    });
                    $("#one_off_btn").on('click', function(e){
                        let ingredient_rows = $("#ingredients_container tr");
                        //There's always a header row we have to ignore
                        //TODO replace this with a more elegant error message box
                        if(ingredient_rows.length <= 1){
                            alert("You need to have at least one ingredient!");
                            return;
                        }
                        
                        let nutrients_list = [
                            $("#calories_total").text(),
                            $("#fat_total").text(),
                            $("#carbs_total").text(),
                            $("#protein_total").text(),
                            $("#fiber_total").text()
                        ]
                        
                        $.ajax({
                            type: 'post',
                            url: '/enter_cal_entry',
                            data: {nutrients: nutrients_list},
                            dataType: 'json'
                        });
                    });
                });
            </script>
        </div>
	</body>

</html>
