<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" type='text/javascript'></script>
        <script src="common.js" type="text/javascript"></script>

        <link rel="stylesheet" href="bootstrap.min.css">
        <link rel="stylesheet" href="common.css">
    </head>

	<body>
        <div id="nav_bar_container">
        </div>
        <div style="margin: auto;width: 20%;text-align: center;min-width: auto;" class="alert alert-danger" id="warning_container">
            <% if(locals.err_msg){ %>
            <%= err_msg %>
            <% } %>
        </div>
        <script>
            if(<%= locals.err_msg === undefined %>){
                $("#warning_container").hide();
            }
        </script>
		<div id="ingredients_options_container">
            <select id="ingredients_list">
                <% for( var i = 0; i < ingredients.length; i++){%>
                    <%var ingredient_name = ingredients[i].ingredient_name; %>
                    <option value="<%= ingredient_name%>"><%= ingredient_name%></option> 
                <% } %>
            </select>
            <input type="button" id="add_ingredient_btn" value="Add Ingredient"></input>
		</div>
        
		<div id="recipes_options_container">
            <select id="recipes_list">
                <% for( var i = 0; i < recipes.length; i++){%>
                    <%var recipe_name = recipes[i].recipe_name; %>
                    <option value="<%= recipe_name%>"><%= recipe_name%></option> 
                <% } %>
            </select>
            <input type="button" id="add_recipe_ings_btn" value="Add From Recipe"></input>
		</div>
        <div>
            <table>
                <tbody id="ingredients_container">
                    <tr>
                        <th>Name</th>
                        <th>Unit</th>
                        <th>Amount</th>
                        <th>Calories</th>
                        <th>Fat</th>
                        <th>Carbs</th>
                        <th>Fiber</th>
                        <th>Protein</th>
                    </tr>
                </tbody>
                <tfoot id="totals_container"></tfoot>
            </table>
        </div>
        <div id="submit_container">
            <div style="width:100%">Any ingredients with amount 0 will not be included.</div>
            <input id="meal_name_input"></input>
            <input type="number" id="meal_weight_input"></input>
            <input type="submit" id="enter_meal_btn" name="action" value="Save to Fridge">
        </div>
        <input type="submit" id="one_off_btn" name="action" value="I Ate It!">

        <div id="scripts_container">
            <script>
                $(document).ready(function(){
                    var nutrient_ids = ["calories", "fat", "carb", "fiber", "protein"]
                    //Add the ingredient to the list
                    $("#add_ingredient_btn").on('click', function(e){
                        add_ingredient(nutrient_ids);
                    });
                    

                    $("#ingredients_container").on('update', function(){
                        update_totals();
                    });

                    $("#add_recipe_ings_btn").on('click', function(e){
                        var recipe_name = $('select[id=recipes_list]').val();

                        $.ajax({
                            type: 'post',
                            url: '/get_recipe_ingredients',
                            data: {recipe_name: recipe_name},
                            dataType: 'json'
                        })
                        .done(function(ingredients_info){
                            //TODO load the recipe ingredients onto the page
                            console.log(ingredients_info);
                        });
                    });

                    function getNutrientTotals(){
                        let ingredient_rows = $("#ingredients_container tr");
                        //There's always a header row we have to ignore
                        //TODO replace this with a more elegant error message box
                        if(ingredient_rows.length <= 1){
                            alert("You need to have at least one ingredient!");
                            return;
                        }
                        
                        let nutrients_list = [
                            $("#calories_total").text(),
                            $("#fat_total").text(),
                            $("#carbs_total").text(),
                            $("#fiber_total").text(),
                            $("#protein_total").text()
                        ]

                        return nutrients_list;
                    }

                    $("#enter_meal_btn").on('click', function(e){
                        let meal_name = $("#meal_name_input").val(); 
                        let meal_weight = $("#meal_weight_input").val();
                        //TODO replace this with a more elegant error message box
                        if(meal_name == "" || meal_weight == ""){
                            alert("You must provide a name and weight!");
                            return;
                        }
                        
                        $.ajax({
                            type: 'post',
                            url: '/add_meal',
                            data: {
                                meal_name: meal_name, 
                                meal_weight: parseFloat(meal_weight), 
                                nutrients: getNutrientTotals()
                            },
                            dataType: 'json'
                        })
                        .done(function(maybeError){
                            if(maybeError.err != ""){
                                let warning_container = $("#warning_container");
                                warning_container.text(maybeError.err);
                                warning_container.show();
                            }
                            else{
                                $("#warning_container").hide();
                            }
                        });

                    });

                    $("#one_off_btn").on('click', function(e){
                        $.ajax({
                            type: 'post',
                            url: '/enter_cal_entry',
                            data: {nutrients: getNutrientTotals()},
                            dataType: 'json'
                        });
                    });
                });
            </script>
        </div>
	</body>

</html>
