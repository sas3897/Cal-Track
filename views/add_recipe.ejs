<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" type='text/javascript'></script>
        <script src="common.js" type="text/javascript"></script>
        <link rel="stylesheet" href="bootstrap.min.css">

        <link rel="stylesheet" href="common.css">
    </head>
	<body>
        <div style="margin: auto;width: 20%;text-align: center;min-width: auto;" class="alert alert-danger" id="warning_container">
            <% if(locals.err_msg){ %>
            <%= err_msg %>
            <% } %>
        </div>
        <script>
            if(<%= locals.err_msg === undefined %>){
                $("#warning_container").hide();
            }
        </script>
		<div id="ingredients_options_container">
            <div style="width=100%">If the ingredient has already been added, its amount will increase by one serving size.</div>
            <select id="ingredients_list">
                <% for( var i = 0; i < ingredients.length; i++){%>
                    <%var ingredient_name = ingredients[i].ingredient_name; %>
                    <option value="<%= ingredient_name%>"><%= ingredient_name%></option> 
                <% } %>
            </select>
            <input id="add_ingredient_btn" type="button" value="Add Ingredient">
		</div>
        <div>
            <table>
                <tbody id="ingredients_container">
                    <tr>
                        <th>Name</th>
                        <th>Unit</th>
                        <th>Amount</th>
                        <th>Calories</th>
                        <th>Fat</th>
                        <th>Carbs</th>
                        <th>Fiber</th>
                        <th>Protein</th>
                    </tr>
                </tbody>
                <tfoot id="totals_container"></tfoot>
            </table>
        </div>
        <div id="submit_container>
            <div style="width:100%">Any ingredients with amount 0 will not be included.</div>
            <input id="recipe_name_input"></input>
            <input type="button" id="submit_btn" value="Save Recipe"></input>
        </div>
        <div id="scripts_container">
            <script>
                $(document).ready(function(){
                    var nutrient_ids = ["calories", "fat", "carb", "fiber", "protein"]
                    //Add the ingredient to the list
                    $("#add_ingredient_btn").on('click', function(e){
                        add_ingredient(nutrient_ids);
                    });
                    

                    $("#ingredients_container").on('update', function(){
                        update_totals();
                    });

                    $("#submit_btn").on('click', function(e){
                        let recipe_name = $("#recipe_name_input").val(); 
                        //TODO replace this with a more elegant error message box
                        if(recipe_name == ""){
                            alert("You must provide a name!");
                            return;
                        }

                        let ingredient_rows = $("#ingredients_container tr");
                        //There's always a header row we have to ignore
                        //TODO replace this with a more elegant error message box
                        if(ingredient_rows.length <= 1){
                            alert("You need to have at least one ingredient!");
                            return;
                        }
                        let ingredients_list = {}
                        for(let idx = 1; idx < ingredient_rows.length; idx++){
                            let ingredient = ingredient_rows.get(idx);
                            let amount = $(ingredient).find("#amount").val();
                            if(parseFloat(amount) > 0){
                                ingredients_list[idx] = {
                                    "name" : $(ingredient).find("#ing_name").text(),
                                    "ratio" : $(ingredient).find("#hid_ratio").val(),
                                }
                            }
                        }
                        
                        if(Object.keys(ingredients_list).length > 0){
                            $.ajax({
                                type: 'post',
                                url: '/add_recipe',
                                data: {recipe_name: recipe_name, ingredients: ingredients_list},
                                dataType: 'json'
                            })
                            .done(function(maybeError){
                                if(maybeError.err != ""){
                                    let warning_container = $("#warning_container");
                                    warning_container.text(maybeError.err);
                                    warning_container.show();
                                }
                                else{
                                    $("#warning_container").hide();
                                }
                            });
                        }
                        else{
                            alert("One non-zero amount of an ingredient is required.");
                        }
                    });
                });
            </script>
        </div>
    </body>
</html>
